#!/bin/bash
set -e

clear

# ๐จ ะัะฐัะธะฒัะน ะฑะฐะฝะฝะตั
echo ""
echo "           _____                _____                    _____                    _____                    _____                    _____ ";
echo "          /\    \              /\    \                  /\    \                  /\    \                  /\    \                  /\    \ ";
echo "         /::\    \            /::\    \                /::\    \                /::\    \                /::\    \                /::\    \ ";
echo "        /::::\    \           \:::\    \              /::::\    \              /::::\    \              /::::\    \              /::::\    \ ";
echo "       /::::::\    \           \:::\    \            /::::::\    \            /::::::\    \            /::::::\    \            /::::::\    \ ";
echo "      /:::/\:::\    \           \:::\    \          /:::/\:::\    \          /:::/\:::\    \          /:::/\:::\    \          /:::/\:::\    \ ";
echo "     /:::/__\:::\    \           \:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        /:::/__\:::\    \        /:::/__\:::\    \ ";
echo "     \:::\   \:::\    \          /::::\    \      /::::\   \:::\    \      /::::\   \:::\    \       \:::\   \:::\    \       \:::\   \:::\    \ ";
echo "   ___\:::\   \:::\    \        /::::::\    \    /::::::\   \:::\    \    /::::::\   \:::\    \    ___\:::\   \:::\    \    ___\:::\   \:::\    \ ";
echo "  /\   \:::\   \:::\    \      /:::/\:::\    \  /:::/\:::\   \:::\____\  /:::/\:::\   \:::\    \  /\   \:::\   \:::\    \  /\   \:::\   \:::\    \ ";
echo " /::\   \:::\   \:::\____\    /:::/  \:::\____\/:::/  \:::\   \:::|    |/:::/__\:::\   \:::\____\/::\   \:::\   \:::\____\/::\   \:::\   \:::\____\ ";
echo " \:::\   \:::\   \::/    /   /:::/    \::/    /\::/   |::::\  /:::|____|\:::\   \:::\   \::/    /\:::\   \:::\   \::/    /\:::\   \:::\   \::/    / ";
echo "  \:::\   \:::\   \/____/   /:::/    / \/____/  \/____|:::::\/:::/    /  \:::\   \:::\   \/____/  \:::\   \:::\   \/____/  \:::\   \:::\   \/____/ ";
echo "   \:::\   \:::\    \      /:::/    /                 |:::::::::/    /    \:::\   \:::\    \       \:::\   \:::\    \       \:::\   \:::\    \ ";
echo "    \:::\   \:::\____\    /:::/    /                  |::|\::::/    /      \:::\   \:::\____\       \:::\   \:::\____\       \:::\   \:::\____\ ";
echo "     \:::\  /:::/    /    \::/    /                   |::| \::/____/        \:::\   \::/    /        \:::\  /:::/    /        \:::\  /:::/    / ";
echo "      \:::\/:::/    /      \/____/                    |::|  ~|               \:::\   \/____/          \:::\/:::/    /          \:::\/:::/    / ";
echo "       \::::::/    /                                  |::|   |                \:::\    \               \::::::/    /            \::::::/    / ";
echo "        \::::/    /                                   \::|   |                 \:::\____\               \::::/    /              \::::/    / ";
echo "         \::/    /                                     \:|   |                  \::/    /                \::/    /                \::/    / ";
echo "          \/____/                                       \|___|                   \/____/                  \/____/                  \/____/ ";


echo ""
echo -n "๐ ะะฐะฟััะบ ัะบัะธะฟัะฐ"; for i in {1..5}; do echo -n "."; sleep 0.3; done; echo -e "\n"

# ะัะพะฒะตัะบะฐ ะทะฐะฟััะบะฐ ะพั root
if [ "$EUID" -ne 0 ]; then
  echo "โ๏ธ ะะพะถะฐะปัะนััะฐ, ะทะฐะฟัััะธัะต ัะบัะธะฟั ั ะฟัะฐะฒะฐะผะธ root ะธะปะธ ัะตัะตะท sudo"
  exit 1
fi

echo "โฌ๏ธ ะัะพะฒะตััะตะผ ะธ ะพะฑะฝะพะฒะปัะตะผ ัะธััะตะผั..."

# ะฃััะฐะฝะพะฒะบะฐ sudo (ะตัะปะธ ะฝะตั)
if ! command -v sudo &>/dev/null; then
  apt update
  apt install -y sudo
fi

# ะะฑะฝะพะฒะปะตะฝะธะต ัะฟะธัะบะฐ ะฟะฐะบะตัะพะฒ
apt update

# ะะพะบะฐะทัะฒะฐะตะผ ัะฟะธัะพะบ ะพะฑะฝะพะฒะปัะตะผัั ะฟะฐะบะตัะพะฒ (ะผะพะถะตั ะฑััั ะผะฝะพะณะพ, ะฟัะตัะฒััั Ctrl+C)
echo "๐ ะกะฟะธัะพะบ ะพะฑะฝะพะฒะปัะตะผัั ะฟะฐะบะตัะพะฒ:"
apt list --upgradable || true

# ะะพะปะฝะพะต ะพะฑะฝะพะฒะปะตะฝะธะต ัะธััะตะผั ะฑะตะท ะฒะพะฟัะพัะพะฒ
apt full-upgrade -y

echo "โ ะะฑะฝะพะฒะปะตะฝะธะต ัะธััะตะผั ะทะฐะฒะตััะตะฝะพ."

# === ะะะะ SSH-ะะะะขะ ===
read -p "๐ ะะฒะตะดะธัะต ะฝะพะฒัะน SSH-ะฟะพัั (ะฟะพ ัะผะพะปัะฐะฝะธั 22): " USER_PORT
SSH_PORT="${USER_PORT:-22}"

echo "๐ฆ ะฃััะฐะฝะพะฒะบะฐ ะธ ะฝะฐัััะพะนะบะฐ nftables..."
if ! command -v nft &>/dev/null; then
    apt install -y nftables
fi

echo "๐งน ะัะธััะบะฐ ััะฐััั ะฟัะฐะฒะธะป..."
nft flush ruleset

echo "๐ก ะกะพะทะดะฐะฝะธะต ัะฐะฑะปะธัั ะธ ัะตะฟะพัะตะบ..."
nft add table inet filter
nft add chain inet filter input { type filter hook input priority 0 \; policy drop \; }

echo "๐ ะะฐะทัะตัะฐะตะผ ััะฐัะธะบ:"
nft add rule inet filter input ct state established,related accept
nft add rule inet filter input iifname "lo" accept

echo "โฑ ะะพะฑะฐะฒะปัะตะผ rate limiting ะดะปั SSH (ะผะฐะบั 3 ะฝะพะฒัั ะฟะพะดะบะปััะตะฝะธั ะฒ ะผะธะฝััั)..."
nft add rule inet filter input tcp dport $SSH_PORT ct state new limit rate 3/minute accept

echo "๐ซ ะะปะพะบะธััะตะผ ICMP ping..."
nft add rule inet filter input icmp type echo-request drop

echo "๐พ ะกะพััะฐะฝัะตะผ ะฟัะฐะฒะธะปะฐ..."
nft list ruleset > /etc/nftables.conf
systemctl enable nftables
systemctl restart nftables

# ========== SSH-ะะะะข ==========
echo "๐ ะะตัะตะฝะพั SSH ะฝะฐ ะฟะพัั $SSH_PORT..."
SSHD_CONFIG="/etc/ssh/sshd_config"
cp "$SSHD_CONFIG" "${SSHD_CONFIG}.bak-$(date +%F_%T)"

if grep -q "^#*Port " "$SSHD_CONFIG"; then
    sed -i "s/^#*Port .*/Port $SSH_PORT/" "$SSHD_CONFIG"
else
    echo "Port $SSH_PORT" >> "$SSHD_CONFIG"
fi

systemctl restart sshd

if ss -tln | grep -q ":$SSH_PORT"; then
    echo "โ SSH ัะปััะฐะตั ะฝะฐ ะฟะพััั $SSH_PORT"
else
    echo "โ ะะะะะะะะ: SSH ะฝะต ัะปััะฐะตั ะฝะฐ ะฝะพะฒะพะผ ะฟะพััั!"
    exit 1
fi

# ========== ะะะะะะก ะะขะะะฎะงะะะะฏ IPv6 ==========
read -p "๐ ะัะบะปััะธัั IPv6? (Y/n, ะฟะพ ัะผะพะปัะฐะฝะธั Y): " DISABLE_IPV6
DISABLE_IPV6=${DISABLE_IPV6:-Y}

REBOOT_REQUIRED=0

if [[ "$DISABLE_IPV6" =~ ^[Yy]$ ]]; then
    echo "๐ ะัะบะปััะตะฝะธะต IPv6..."
    GRUB_CONF="/etc/default/grub"

    if ! grep -q "ipv6.disable=1" "$GRUB_CONF"; then
        sed -i 's/^GRUB_CMDLINE_LINUX="/GRUB_CMDLINE_LINUX="ipv6.disable=1 /' "$GRUB_CONF"
        update-grub
    fi

    cat > /etc/sysctl.d/99-disable-ipv6.conf <<EOF
net.ipv6.conf.all.disable_ipv6 = 1
net.ipv6.conf.default.disable_ipv6 = 1
net.ipv6.conf.lo.disable_ipv6 = 1
EOF

    sysctl --system
    echo "โ IPv6 ะพัะบะปัััะฝ (ะดะปั ะฟะพะปะฝะพะณะพ ัััะตะบัะฐ ะฝัะถะฝะฐ ะฟะตัะตะทะฐะณััะทะบะฐ)"
    REBOOT_REQUIRED=1
else
    echo "โน๏ธ IPv6 ะพััะฐะฒะปะตะฝ ะฒะบะปัััะฝะฝัะผ"
fi

# === ะกะะะะ ะะะะะะฏ SSH-ะะะะฌะะะะะขะะะฏ ===
read -p "๐ ะฅะพัะธัะต ัะผะตะฝะธัั ะฟะฐัะพะปั ะฟะพะปัะทะพะฒะฐัะตะปั ะดะปั SSH? (Y/n, ะฟะพ ัะผะพะปัะฐะฝะธั Y): " CHANGE_PASS
CHANGE_PASS=${CHANGE_PASS:-Y}

if [[ "$CHANGE_PASS" =~ ^[Yy]$ ]]; then
  echo "๐ค ะขะตะบััะธะน ะฟะพะปัะทะพะฒะฐัะตะปั: $SUDO_USER"
  TARGET_USER="${SUDO_USER:-root}"

  if id "$TARGET_USER" &>/dev/null; then
    echo "๐ ะะฒะตะดะธัะต ะฝะพะฒัะน ะฟะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั '$TARGET_USER':"
    passwd "$TARGET_USER"
    echo "โ ะะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั '$TARGET_USER' ััะฟะตัะฝะพ ะธะทะผะตะฝัะฝ."
    echo -e "\n๐ ะะต ะทะฐะฑัะดััะต ัะพััะฐะฝะธัั ะฝะพะฒัะน ะฟะฐัะพะปั ะดะปั ะฟะพะปัะทะพะฒะฐัะตะปั '$TARGET_USER'!"
  else
    echo "โ ะะพะปัะทะพะฒะฐัะตะปั '$TARGET_USER' ะฝะต ะฝะฐะนะดะตะฝ."
  fi
else
  echo "โน๏ธ ะะฐัะพะปั ะพััะฐะฒะปะตะฝ ะฑะตะท ะธะทะผะตะฝะตะฝะธะน."
fi

# === ะะะะะะจะะะะ ===
echo -e "\n๐ ะัั ะณะพัะพะฒะพ:"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"
echo " โ ะะธะฝะณ ะพัะบะปัััะฝ"
echo " โ SSH ะฟะตัะตะฝะตััะฝ ะฝะฐ ะฟะพัั: $SSH_PORT"
echo " โ nftables ะฝะฐัััะพะตะฝ ะธ ะฐะบัะธะฒะตะฝ"
[[ "$DISABLE_IPV6" =~ ^[Yy]$ ]] && echo " โ IPv6 ะพัะบะปัััะฝ"
[[ "$CHANGE_PASS" =~ ^[Yy]$ ]] && echo " โ ะะฐัะพะปั ะฟะพะปัะทะพะฒะฐัะตะปั '$TARGET_USER' ะพะฑะฝะพะฒะปัะฝ"
echo "โโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโโ"

if [ $REBOOT_REQUIRED -eq 1 ]; then
    echo -e "\n๐ ะกะตัะฒะตั ะฑัะดะตั ะฟะตัะตะทะฐะณััะถะตะฝ ัะตัะตะท 5 ัะตะบัะฝะด. ะะต ะทะฐะฑัะดััะต ะธัะฟะพะปัะทะพะฒะฐัั *ะฝะพะฒัะน SSH-ะฟะพัั*: $SSH_PORT"
    sleep 5
    reboot
else
    echo -e "\nโน๏ธ ะะตัะตะทะฐะณััะทะบะฐ ะฝะต ััะตะฑัะตััั."
fi
