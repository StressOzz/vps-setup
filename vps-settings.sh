#!/bin/bash
set -e

VERSION="v3.7"

clear

# –¶–≤–µ—Ç–∞
GREEN='\033[1;32m'
CYAN='\033[1;36m'
WHITE='\033[1;37m'
RED='\033[1;91m'
PURPLE='\033[1;35m'
YELLOW='\033[1;33m'
RESET='\033[0m'

echo ""
echo "  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñì ‚ñà‚ñà‚ñÄ‚ñà‚ñà‚ñà  ‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà "
echo "‚ñí‚ñà‚ñà    ‚ñí ‚ñì  ‚ñà‚ñà‚ñí ‚ñì‚ñí‚ñì‚ñà‚ñà ‚ñí ‚ñà‚ñà‚ñí‚ñì‚ñà   ‚ñÄ ‚ñí‚ñà‚ñà    ‚ñí ‚ñí‚ñà‚ñà    ‚ñí "
echo "‚ñë ‚ñì‚ñà‚ñà‚ñÑ   ‚ñí ‚ñì‚ñà‚ñà‚ñë ‚ñí‚ñë‚ñì‚ñà‚ñà ‚ñë‚ñÑ‚ñà ‚ñí‚ñí‚ñà‚ñà‚ñà   ‚ñë ‚ñì‚ñà‚ñà‚ñÑ   ‚ñë ‚ñì‚ñà‚ñà‚ñÑ   "
echo "  ‚ñí   ‚ñà‚ñà‚ñí‚ñë ‚ñì‚ñà‚ñà‚ñì ‚ñë ‚ñí‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñÑ  ‚ñí‚ñì‚ñà  ‚ñÑ   ‚ñí   ‚ñà‚ñà‚ñí  ‚ñí   ‚ñà‚ñà‚ñí"
echo "‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí  ‚ñí‚ñà‚ñà‚ñí ‚ñë ‚ñë‚ñà‚ñà‚ñì ‚ñí‚ñà‚ñà‚ñí‚ñë‚ñí‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí"
echo "‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë  ‚ñí ‚ñë‚ñë   ‚ñë ‚ñí‚ñì ‚ñë‚ñí‚ñì‚ñë‚ñë‚ñë ‚ñí‚ñë ‚ñë‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë"
echo "‚ñë ‚ñë‚ñí  ‚ñë ‚ñë    ‚ñë      ‚ñë‚ñí ‚ñë ‚ñí‚ñë ‚ñë ‚ñë  ‚ñë‚ñë ‚ñë‚ñí  ‚ñë ‚ñë‚ñë ‚ñë‚ñí  ‚ñë ‚ñë"
echo "‚ñë  ‚ñë  ‚ñë    ‚ñë        ‚ñë‚ñë   ‚ñë    ‚ñë   ‚ñë  ‚ñë  ‚ñë  ‚ñë  ‚ñë  ‚ñë  "
echo "      ‚ñë              ‚ñë        ‚ñë  ‚ñë      ‚ñë        ‚ñë  "
echo ""

echo -e "–í–µ—Ä—Å–∏—è —Å–∫—Ä–∏–ø—Ç–∞: ${VERSION}"
echo ""

# –ü—Ä–æ–≤–µ—Ä–∫–∞ sudo
if ! command -v sudo >/dev/null 2>&1; then
    echo -e "${CYAN}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º sudo...${RESET}"
    apt update && apt install -y sudo
fi

# –ü—Ä–æ–≤–µ—Ä–∫–∞ curl
if ! command -v curl >/dev/null 2>&1; then
    echo -e "${CYAN}üì¶ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º curl...${RESET}"
    sudo apt install -y curl
fi

# –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å–∏—Å—Ç–µ–º—ã
echo -e "\n${PURPLE}üîπ –û–±–Ω–æ–≤–ª—è–µ–º —Å–∏—Å—Ç–µ–º—É...${RESET}"
sudo apt update
sudo apt list --upgradable
sudo apt full-upgrade -y

clear
echo ""
echo "  ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà ‚ñÑ‚ñÑ‚ñÑ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñì ‚ñà‚ñà‚ñÄ‚ñà‚ñà‚ñà  ‚ñì‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà   ‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà "
echo "‚ñí‚ñà‚ñà    ‚ñí ‚ñì  ‚ñà‚ñà‚ñí ‚ñì‚ñí‚ñì‚ñà‚ñà ‚ñí ‚ñà‚ñà‚ñí‚ñì‚ñà   ‚ñÄ ‚ñí‚ñà‚ñà    ‚ñí ‚ñí‚ñà‚ñà    ‚ñí "
echo "‚ñë ‚ñì‚ñà‚ñà‚ñÑ   ‚ñí ‚ñì‚ñà‚ñà‚ñë ‚ñí‚ñë‚ñì‚ñà‚ñà ‚ñë‚ñÑ‚ñà ‚ñí‚ñí‚ñà‚ñà‚ñà   ‚ñë ‚ñì‚ñà‚ñà‚ñÑ   ‚ñë ‚ñì‚ñà‚ñà‚ñÑ   "
echo "  ‚ñí   ‚ñà‚ñà‚ñí‚ñë ‚ñì‚ñà‚ñà‚ñì ‚ñë ‚ñí‚ñà‚ñà‚ñÄ‚ñÄ‚ñà‚ñÑ  ‚ñí‚ñì‚ñà  ‚ñÑ   ‚ñí   ‚ñà‚ñà‚ñí  ‚ñí   ‚ñà‚ñà‚ñí"
echo "‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí  ‚ñí‚ñà‚ñà‚ñí ‚ñë ‚ñë‚ñà‚ñà‚ñì ‚ñí‚ñà‚ñà‚ñí‚ñë‚ñí‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí‚ñí‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñí‚ñí"
echo "‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë  ‚ñí ‚ñë‚ñë   ‚ñë ‚ñí‚ñì ‚ñë‚ñí‚ñì‚ñë‚ñë‚ñë ‚ñí‚ñë ‚ñë‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë‚ñí ‚ñí‚ñì‚ñí ‚ñí ‚ñë"
echo "‚ñë ‚ñë‚ñí  ‚ñë ‚ñë    ‚ñë      ‚ñë‚ñí ‚ñë ‚ñí‚ñë ‚ñë ‚ñë  ‚ñë‚ñë ‚ñë‚ñí  ‚ñë ‚ñë‚ñë ‚ñë‚ñí  ‚ñë ‚ñë"
echo "‚ñë  ‚ñë  ‚ñë    ‚ñë        ‚ñë‚ñë   ‚ñë    ‚ñë   ‚ñë  ‚ñë  ‚ñë  ‚ñë  ‚ñë  ‚ñë  "
echo "      ‚ñë              ‚ñë        ‚ñë  ‚ñë      ‚ñë        ‚ñë  "
echo ""

echo -e "\n${GREEN}‚úÖ –°–∏—Å—Ç–µ–º–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∞.${RESET}"
echo ""

# –ò–∑–º–µ–Ω–µ–Ω–∏–µ SSH –ø–æ—Ä—Ç–∞ —Å –ø—Ä–æ–≤–µ—Ä–∫–æ–π
echo -e "${WHITE}üîπ–ò–∑–º–µ–Ω—è–µ–º –ø–æ—Ä—Ç SSH${RESET}"
echo -e "\n${RED}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π SSH –ø–æ—Ä—Ç (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å):${RESET} \c"
read -r NEW_SSH_PORT

if [[ -n "$NEW_SSH_PORT" ]]; then
    if [[ "$NEW_SSH_PORT" =~ ^[0-9]+$ && "$NEW_SSH_PORT" -ge 1 && "$NEW_SSH_PORT" -le 65535 ]]; then
        if ss -tuln | grep -q ":$NEW_SSH_PORT "; then
            echo -e "${RED}‚ùå –ü–æ—Ä—Ç $NEW_SSH_PORT —É–∂–µ –∑–∞–Ω—è—Ç. –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã.${RESET}"
            NEW_SSH_PORT=$(grep ^Port /etc/ssh/sshd_config | awk '{print $2}')
        else
            sudo cp /etc/ssh/sshd_config /etc/ssh/sshd_config.bak.$(date +%F)
            sudo sed -i "s/^#\?Port .*/Port $NEW_SSH_PORT/" /etc/ssh/sshd_config
            sudo systemctl restart sshd && echo -e "${GREEN}‚úÖ SSH –ø–æ—Ä—Ç –∏–∑–º–µ–Ω—ë–Ω.${RESET}" || echo -e "${RED}‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç—å SSH!${RESET}"
        fi
    else
        echo -e "${RED}‚ùå –ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π –ø–æ—Ä—Ç. –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã.${RESET}"
        NEW_SSH_PORT=$(grep ^Port /etc/ssh/sshd_config | awk '{print $2}')
    fi
else
    NEW_SSH_PORT=$(grep ^Port /etc/ssh/sshd_config | awk '{print $2}')
    echo -e "${GREEN}‚úÖ SSH –ø–æ—Ä—Ç –æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.${RESET}"
fi

# –°–º–µ–Ω–∞ root-–ø–∞—Ä–æ–ª—è —Å –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ–º
echo ""
echo -e "${WHITE}üîπ–ò–∑–º–µ–Ω—è–µ–º –ø–∞—Ä–æ–ª—å root${RESET}"
echo -e "\n${RED}–í–≤–µ–¥–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å root (–æ—Å—Ç–∞–≤—å—Ç–µ –ø—É—Å—Ç—ã–º, —á—Ç–æ–±—ã –Ω–µ –º–µ–Ω—è—Ç—å):${RESET} \c"
read -rs NEW_ROOT_PASS

if [[ -n "$NEW_ROOT_PASS" ]]; then
    echo -e "\n${RED}–ü–æ–≤—Ç–æ—Ä–∏—Ç–µ –Ω–æ–≤—ã–π –ø–∞—Ä–æ–ª—å –¥–ª—è –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏—è:${RESET} \c"
    read -rs NEW_ROOT_PASS_CONFIRM
    echo ""
    if [[ "$NEW_ROOT_PASS" == "$NEW_ROOT_PASS_CONFIRM" ]]; then
        echo "root:$NEW_ROOT_PASS" | sudo chpasswd
        echo -e "\n${GREEN}‚úÖ –ü–∞—Ä–æ–ª—å root –∏–∑–º–µ–Ω—ë–Ω.${RESET}"
    else
        echo -e "\n${RED}‚ùå –ü–∞—Ä–æ–ª–∏ –Ω–µ —Å–æ–≤–ø–∞–¥–∞—é—Ç. –ò–∑–º–µ–Ω–µ–Ω–∏—è –æ—Ç–º–µ–Ω–µ–Ω—ã.${RESET}"
    fi
else
    echo -e "\n${GREEN}‚úÖ –ü–∞—Ä–æ–ª—å root –æ—Å—Ç–∞–≤–ª–µ–Ω –±–µ–∑ –∏–∑–º–µ–Ω–µ–Ω–∏–π.${RESET}"
fi

# –û—Ç–∫–ª—é—á–µ–Ω–∏–µ ICMP
if ! grep -q "net.ipv4.icmp_echo_ignore_all" /etc/sysctl.conf; then
    echo "net.ipv4.icmp_echo_ignore_all = 1" | sudo tee -a /etc/sysctl.conf >/dev/null
    sudo sysctl -p >/dev/null 2>&1
    echo -e "\n${GREEN}‚úÖ –ü–∏–Ω–≥ (ICMP echo-request) –æ—Ç–∫–ª—é—á—ë–Ω.${RESET}"
else
    echo -e "\n${GREEN}‚úÖ –ü–∏–Ω–≥ —É–∂–µ –±—ã–ª –æ—Ç–∫–ª—é—á—ë–Ω —Ä–∞–Ω–µ–µ.${RESET}"
fi

# –ò—Ç–æ–≥
IP_ADDR=$(curl -s https://ipinfo.io/ip)
echo -e "\n${GREEN}‚úÖ –í—Å–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –≤—ã–ø–æ–ª–Ω–µ–Ω—ã!${RESET}"
echo ""
echo -e "${WHITE}==============================${RESET}"
echo -e "üåê ${CYAN}IP —Å–µ—Ä–≤–µ—Ä–∞:${RESET}     ${YELLOW}$IP_ADDR${RESET}"
echo -e "üì° ${CYAN}–ü–æ—Ä—Ç SSH:${RESET}       ${YELLOW}$NEW_SSH_PORT${RESET}"
[[ -n "$NEW_ROOT_PASS" && "$NEW_ROOT_PASS" == "$NEW_ROOT_PASS_CONFIRM" ]] && echo -e "üîë ${CYAN}–ü–∞—Ä–æ–ª—å root:${RESET}    ${YELLOW}$NEW_ROOT_PASS${RESET}"
echo -e "${WHITE}==============================${RESET}"

# –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞
echo -e "\n${RED}–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∏—Ç—å —Å–∏—Å—Ç–µ–º—É —Å–µ–π—á–∞—Å? (y/N):${RESET} \c"
read -r REBOOT
if [[ "$REBOOT" =~ ^[Yy]$ ]]; then
    echo ""
    echo -e "${YELLOW}–ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞ —á–µ—Ä–µ–∑:${RESET}"
    for i in {5..1}; do
        echo -ne "${CYAN} $i${RESET} "
        sleep 1
    done
    echo ""
    echo -e "\n${PURPLE}üöÄ –ü–µ—Ä–µ–∑–∞–≥—Ä—É–∑–∫–∞...${RESET}"
    echo ""
    sudo reboot
else
    echo -e "${GREEN}‚úÖ –°–∫—Ä–∏–ø—Ç –∑–∞–≤–µ—Ä—à—ë–Ω.${RESET}"
    echo ""
fi
